AWSTemplateFormatVersion: '2010-09-09'
Description: Drupal Webserver Template (qs-1nqqf5kol)
Metadata:
  LICENSE: Apache License Version 2.0
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Network Configuration
        Parameters:
          - WebServerSubnets
          - WebELBSecurityGroup
          - WebServerSecurityGroup
          - PublicSubnet1ID
          - PublicSubnet2ID
          - VPCID
          - EFSSecurityGroup
      - Label:
          default: Database Configuration
        Parameters:
          - DBEndpointAddress
          - DBMainUsername
          - DBMainUserPassword
          - DrupalDbName
          - DrupalDbUsername
          - DrupalDbPassword
      - Label:
          default: Drupal Configuration
        Parameters:
          - PhpVersion
          - DrupalVersion
          - DrupalSiteName
          - DrupalSiteAdminEmail
          - DrupalSiteAdminUsername
          - DrupalSiteAdminPassword
          - DrupalSiteDomain
          - Route53HostedZoneId
      - Label:
          default: Drupal Webserver Configuration
        Parameters:
          - WebServerInstanceType
          - AutoScalingNotificationEmail
          - WebServerMinSize
          - WebServerMaxSize
          - WebServerDesiredCapacity
          - KeyPair
          - SSLCertificateId
          - LatestAmiId
      - Label:
          default: CDN - CloudFront Configuration
        Parameters:
          - CloudFrontEnable
          - CFSSLCertificateId
          - CloudFrontPriceClass
          - CloudFrontAlias
      - Label:
          default: ElastiCache Configuration
        Parameters:
          - EnableElastiCache
          - ElastiCacheClusterId
      - Label:
          default: AWS Quick Start Configuration
        Parameters:
          - QSS3BucketName
          - QSS3BucketRegion
          - QSS3KeyPrefix
    ParameterLabels:
      WebServerSubnets:
        default: Private Subnets
      WebELBSecurityGroup:
        default: ELB Security Group
      WebServerSecurityGroup:
        default: Web Server Security Group
      PublicSubnet1ID:
        default: Public Subnet 1 ID
      PublicSubnet2ID:
        default: Public Subnet 2 ID
      VPCID:
        default: VPC ID
      EFSSecurityGroup:
        default: EFS Security Group
      DBEndpointAddress:
        default: Aurora DB Endpoint
      DBMainUsername:
        default: Database Admin Username
      DBMainUserPassword:
        default: Database Admin Password
      DrupalDbName:
        default: Drupal Database Name
      DrupalDbUsername:
        default: Drupal Database Username
      DrupalDbPassword:
        default: Drupal Database Password
      PhpVersion:
        default: PHP Version
      DrupalVersion:
        default: Drupal Version
      DrupalSiteName:
        default: Drupal Site Name
      DrupalSiteAdminEmail:
        default: Drupal Site Admin Email
      DrupalSiteAdminUsername:
        default: Drupal Site Admin Username
      DrupalSiteAdminPassword:
        default: Drupal Site Admin Password
      DrupalSiteDomain:
        default: Drupal Site Domain
      Route53HostedZoneId:
        default: Route53 Hosted Zone ID
      WebServerInstanceType:
        default: Webserver Instance Size
      AutoScalingNotificationEmail:
        default: Autoscaling Notification Email
      WebServerMaxSize:
        default: Max Number of Instances
      WebServerMinSize:
        default: Min Number of Instances
      WebServerDesiredCapacity:
        default: Desired number of Instances
      KeyPair:
        default: Bastion Host KeyPair Name
      SSLCertificateId:
        default: SSL Certificate ARN for ALB HTTPS Listener
      LatestAmiId:
        default: Latest Amazon Linux 2 AMI
      CloudFrontEnable:
        default: Enable CloudFront
      CFSSLCertificateId:
        default: SSL Certificate ARN for CloudFront Distribution
      CloudFrontPriceClass:
        default: CloudFront PriceClass
      CloudFrontAlias:
        default: Alias for the CloudFront distribution
      EnableElastiCache:
        default: Enable ElastiCache
      ElastiCacheClusterId:
        default: ElastiCache Cluster Id
      QSS3BucketName:
        default: Quick Start S3 Bucket Name
      QSS3BucketRegion:
        default: Quick Start S3 bucket region
      QSS3KeyPrefix:
        default: Quick Start S3 Key Prefix
Parameters:
  QSS3BucketName:
    AllowedPattern: ^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$
    ConstraintDescription: AWS Quick Start bucket name can include numbers, lowercase
      letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen
      (-).
    Default: aws-quickstart
    Description: S3 bucket name for the AWS Quick Start assets. AWS Quick Start bucket
      name can include numbers, lowercase letters, uppercase letters, and hyphens
      (-). It cannot start or end with a hyphen (-).
    Type: String
  QSS3BucketRegion:
    Default: 'us-east-1'
    Description: 'The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value.'
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: ^[0-9a-zA-Z-/]*$
    ConstraintDescription: >-
      AWS Quick Start key prefix can include numbers, lowercase letters, uppercase
      letters, hyphens (-), and forward slash (/). It cannot start or end with forward
      slash (/) because they are automatically appended.
    Default: quickstart-drupal/
    Description: >-
      S3 key prefix for the AWS Quick Start assets.AWS Quick Start key prefix can
      include numbers, lowercase letters, uppercase letters, hyphens (-), and forward
      slash (/). It cannot start or end with forward slash (/) because they are automatically
      appended.
    Type: String
  AutoScalingNotificationEmail:
    AllowedPattern: ([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)
    ConstraintDescription: Must be a valid email address.
    Description: Email address to notify Auto Scaling operations
    Type: String
  WebServerSubnets:
    ConstraintDescription: must be list of existing subnet Ids
    Default: ''
    Description: A list of subnet identifiers of Amazon VPCs where the WebServer Autoscaling
      would be launched.
    Type: List<AWS::EC2::Subnet::Id>
  EFSSecurityGroup:
    Description: EFS Security Group
    Type: AWS::EC2::SecurityGroup::Id
  WebServerInstanceType:
    AllowedValues:
      - t3.medium
      - t3.large
      - t3a.medium
      - t3a.large
      - m5.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.8xlarge
      - m5a.large
      - m5.xlarge
      - m5.2xlarge
      - m5.4xlarge
      - m5.8xlarge
      - c5.large
      - c5.xlarge
      - c5.2xlarge
      - c5.4xlarge
      - c5.9xlarge
      - c5a.large
      - c5a.xlarge
      - c5a.2xlarge
      - c5a.4xlarge
      - c5a.8xlarge
      - r5.large
      - r5.xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.8xlarge
      - r5a.large
      - r5a.xlarge
      - r5a.2xlarge
      - r5a.4xlarge
      - r5a.8xlarge
    ConstraintDescription: Choose an instance type.
    Default: t3.medium
    Description: Web Server node instance type
    Type: String
  WebServerSecurityGroup:
    Description: Web Server Security Group
    Type: AWS::EC2::SecurityGroup::Id
  KeyPair:
    ConstraintDescription: Must be the name of an existing EC2 KeyPair.
    Default: id_rsa_aws
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: AWS::EC2::KeyPair::KeyName
  LatestAmiId:
    Type: 'AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>'
    Default: '/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2'
    Description: Latest Amazon Linux 2 AMI
  DBEndpointAddress:
    Description: Aurora DB Endpoint
    Type: String
  DBMainUsername:
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric
      characters.
    Default: dbadmin
    Description: The database admin account username
    MaxLength: '16'
    MinLength: '1'
    Type: String
  DBMainUserPassword:
    AllowedPattern: (?=\S)[^@/"\r\n\t\f\s]*
    ConstraintDescription: Min 8 chars.
    Description: The database admin account password
    MaxLength: '41'
    MinLength: '8'
    NoEcho: 'True'
    Type: String
  DrupalDbName:
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    Default: drupaldb
    Description: Name of the Database to be created and used for Drupal
    MaxLength: '64'
    MinLength: '5'
    Type: String
  DrupalDbUsername:
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric
      characters.
    Default: drupal
    Description: The drupal database user account
    MaxLength: '16'
    MinLength: '1'
    Type: String
  DrupalDbPassword:
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: Must contain only alphanumeric characters and must be between
      8 and 41 characters long.
    Description: The drupal database user account password
    MaxLength: '41'
    MinLength: '8'
    Type: String
    NoEcho: 'true'
  PhpVersion:
    AllowedValues:
      - 'php7.2'
      - 'php7.3'
      - 'php7.4'
    ConstraintDescription: 'Choose a valid PHP version. Values can be php7.2, php7.3, php7.4'
    Default: 'php7.4'
    Description: PHP version to be installed. PHP-7.2=php7.2, PHP-7.3=php7.3, PHP-7.4=php7.4
    Type: String
  DrupalVersion:
    Description: Drupal version to install
    Type: String
    AllowedValues:
      - '7'
      - '8'
      - '9'
    ConstraintDescription: Allowed values 7, 8 or 9
    Default: '9'
  DrupalSiteName:
    Description: Descriptive name for your drupal site
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9 ]*'
    ConstraintDescription: Min 5 chars. Only alphanumeric
    Default: My Site
    MaxLength: '64'
    MinLength: '5'
    Type: String
  DrupalSiteAdminEmail:
    AllowedPattern: ([a-zA-Z0-9_\-\.]+)@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.)|(([a-zA-Z0-9\-]+\.)+))([a-zA-Z]{2,4}|[0-9]{1,3})(\]?)
    ConstraintDescription: Must be a valid email address.
    Description: Drupal Site Administrator Email
    Type: String
  DrupalSiteAdminUsername:
    Description: The Drupal site admin account username
    Type: String
    MinLength: '5'
    MaxLength: '16'
    Default: admin
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: Must begin with a letter, contain only alphanumeric characters
      and must be between 5 and 16 characters long
  DrupalSiteAdminPassword:
    Description: The Drupal site admin account password
    Type: String
    MinLength: '8'
    MaxLength: '41'
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: Must contain only alphanumeric characters and must be between
      8 and 41 characters long.
    NoEcho: 'true'
  DrupalSiteDomain:
    Description: Domain name of the site. e.g. example.com. Valid FQDN required when
      using SSL. Leave the default localhost.local for test environments.
    AllowedPattern: (?!-)[a-zA-Z0-9-.]*(?<!-)
    ConstraintDescription: Must be a valid fully-qualified domain name.
    Type: String
    Default: localhost.local
  WebServerMinSize:
    Default: '1'
    Description: Minimum number of web server instances in Auto Scaling group
    Type: Number
  WebServerMaxSize:
    Default: '12'
    Description: Maximum number of web server instances in Auto Scaling group
    Type: Number
  WebServerDesiredCapacity:
    Default: '2'
    Description: Desired number of web server instances in Auto Scaling group
    Type: Number
  VPCID:
    Description: Select the VPC to deploy Drupal
    Type: AWS::EC2::VPC::Id
  PublicSubnet1ID:
    Description: Public Subnet ID 1 located in Availability Zone 1
    Type: AWS::EC2::Subnet::Id
  PublicSubnet2ID:
    Description: Public Subnet ID 2 located in Availability Zone 2
    Type: AWS::EC2::Subnet::Id
  WebELBSecurityGroup:
    Description: ELB Security Group
    Type: AWS::EC2::SecurityGroup::Id
  SSLCertificateId:
    Default: ''
    Description: The ARN of the SSL certificate to use for the load balancer. [optional]
    Type: String
  CloudFrontEnable:
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Description: Enable CloudFront Content Delivery Network
    Type: String
  CFSSLCertificateId:
    Default: ''
    Description: (Optional) The ARN of the SSL certificate to use for the CloudFront Distribution(from us-east-1) 
    Type: String
  CloudFrontPriceClass:
    AllowedValues:
      - use-all-edge-locations
      - use-only-us-canada-europe-asia
      - use-only-us-canada-europe
    Default: use-all-edge-locations
    Description: Select the price class associated with the maximum price that you
      want to pay for CloudFront service. If you select a price class other than All,
      some of your users may experience higher latency.
    Type: String
    ConstraintDescription: Select a valid CloudFront Price Class.
  CloudFrontAlias:
    Description: Alias for the CloudFront distribution. E.g. cdn.example.com. Mandatory
      when using HTTPS/SSL and optional when using http.
    Type: String
    Default: cdn.default
    AllowedPattern: (?!-)[a-zA-Z0-9-.]*(?<!-)
    ConstraintDescription: Must be a valid fully-qualified domain name.
  Route53HostedZoneId:
    Description: Route53 Hosted Zone ID
    Type: String
    Default: ''
  EnableElastiCache:
    Description: Enable ElastiCache
    AllowedValues:
      - 'true'
      - 'false'
    Default: 'true'
    Type: String
  ElastiCacheClusterId:
    Description: ElastiCache Cluster Id
    Type: String
    Default: ''
Rules:
  SslAndRoute53Rule:
    RuleCondition: !Or
      - !Not
        - !Equals
          - !Ref 'SSLCertificateId'
          - ''
      - !Not
        - !Equals
          - !Ref 'Route53HostedZoneId'
          - ''
    Assertions:
      - Assert: !Not
          - !Equals
            - !Ref 'DrupalSiteDomain'
            - localhost.local
        AssertDescription: Parameter DrupalSiteDomain cannot be the default value
          'localhost.local' and must provide FQDN e.g. example.com, when SSLCertificateId
          or Route53HostedZoneIdis values are provided.
  CFSslAndRoute53Rule:
    RuleCondition: !Or
      - !Not
        - !Equals
          - !Ref 'CFSSLCertificateId'
          - ''
      - !Not
        - !Equals
          - !Ref 'Route53HostedZoneId'
          - ''
    Assertions:
      - Assert: !Not
          - !Equals
            - !Ref 'CloudFrontAlias'
            - cdn.default
        AssertDescription: Parameter CloudFrontAlias cannot be the default value 'cdn.default'
          and must provide FQDN e.g. cdn.example.com, when SSLCertificateId or Route53HostedZoneIdis
          values are provided.
  ElastiCacheRule:
    RuleCondition: !Equals
      - !Ref 'EnableElastiCache'
      - 'true'
    Assertions:
      - Assert: !Not
          - !Equals
            - !Ref 'ElastiCacheClusterId'
            - ''
        AssertDescription: ElastiCacheClusterId cannot be empty when EnableElastiCache
          is true.
Conditions:
  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']
  GovCloudCondition: !Equals
    - !Ref 'AWS::Region'
    - us-gov-west-1
  UseSSL: !Not
    - !Equals
      - !Ref 'SSLCertificateId'
      - ''
  CFUseSSL: !Not
    - !Equals
      - !Ref 'CFSSLCertificateId'
      - ''
  DrupalCdnModuleCondition: !Equals
    - !Ref 'CloudFrontEnable'
    - 'true'
  EnableElastiCacheCondition: !Equals
    - !Ref 'EnableElastiCache'
    - 'true'
  DrupalSiteDomainRoute53Condition: !And
    - !Not
      - !Equals
        - !Ref 'DrupalSiteDomain'
        - localhost.local
    - !Not
      - !Equals
        - !Ref 'Route53HostedZoneId'
        - ''
  CloudFrontAliasRoute53Condition: !And
    - !Not
      - !Equals
        - !Ref 'CloudFrontAlias'
        - cdn.default
    - !Not
      - !Equals
        - !Ref 'Route53HostedZoneId'
        - ''
    - !Equals
      - !Ref 'CloudFrontEnable'
      - 'true'
Resources:
  DrupalEFS:
    Type: AWS::EFS::FileSystem
    Properties:
      PerformanceMode: generalPurpose
      Encrypted: true
      FileSystemTags:
        - Key: Name
          Value: Drupal EFS Shared Filesystem
  DrupalEFSMountTarget1:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref 'DrupalEFS'
      SubnetId: !Select
        - '0'
        - !Ref 'WebServerSubnets'
      SecurityGroups:
        - !Ref 'EFSSecurityGroup'
  DrupalEFSMountTarget2:
    Type: AWS::EFS::MountTarget
    Properties:
      FileSystemId: !Ref 'DrupalEFS'
      SubnetId: !Select
        - '1'
        - !Ref 'WebServerSubnets'
      SecurityGroups:
        - !Ref 'EFSSecurityGroup'
  WebServerInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      Path: /
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DescribeElastiCacheClusterPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Action:
                  - elasticache:DescribeCacheClusters
                Effect: Allow
                Resource: !Sub 'arn:${AWS::Partition}:elasticache:${AWS::Region}:${AWS::AccountId}:cluster:*'
  WebServerInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'WebServerInstanceRole'
  DrupalAMIEC2Instance:
    Type: AWS::EC2::Instance
    DependsOn:
      - DrupalEFSMountTarget1
      - DrupalEFSMountTarget2
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          install_drupal:
            - install_cfn
            - mount_efs
            - enable_php_repo
            - createdb
            - install-packageSet
            - !Join
              - ''
              - - drupal-install-
                - !Ref 'DrupalVersion'
            - !If
              - EnableElastiCacheCondition
              - !Join
                - ''
                - - memcached-drupal-
                  - !Ref 'DrupalVersion'
              - !Ref 'AWS::NoValue'
          drupal_cdn_module:            
            - !Join
              - ''
              - - install-cdn-module-
                - !Ref 'DrupalVersion'
        install_cfn:
          files:
            /etc/cfn/cfn-hup.conf:
              content: !Join
                - ''
                - - "[main]\n"
                  - stack=
                  - !Ref 'AWS::StackId'
                  - "\n"
                  - region=
                  - !Ref 'AWS::Region'
                  - "\n"
                  - verbose=true
              mode: '000400'
              owner: root
              group: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Join
                - ''
                - - "[cfn-auto-reloader-hook]\n"
                  - "triggers=post.update\n"
                  - "path=Resources.DrupalAMIEC2Instance.Metadata.AWS::CloudFormation::Init\n"
                  - 'action=/opt/aws/bin/cfn-init -v '
                  - '--stack '
                  - !Ref 'AWS::StackName'
                  - ' '
                  - '--resource DrupalAMIEC2Instance '
                  - '--configsets install_drupal '
                  - '--region '
                  - !Ref 'AWS::Region'
                  - "\n"
              mode: '000400'
              owner: root
              group: root
          services:
            sysvinit:
              cfn-hup:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/cfn/cfn-hup.conf
                  - /etc/cfn/hooks.d/cfn-auto-reloader.conf
        mount_efs:
          packages:
            yum:
              nfs-utils: []
          files:
            /tmp/mount-efs.sh:
              content: !Join
                - ''
                - - "#!/bin/bash\n"
                  - LINE="
                  - !Join
                    - ''
                    - - !Ref 'DrupalEFS'
                      - .efs.
                      - !Ref 'AWS::Region'
                      - .amazonaws.com
                      - ':/ '
                  - "/var/www nfs4 nfsvers=4.1,rsize=1048576,wsize=1048576,hard,timeo=600,retrans=2\
                    \ 0 0\"\n"
                  - "grep -q \"$LINE\" /etc/fstab || echo \"$LINE\" >> /etc/fstab\n"
              mode: '000500'
              owner: root
              group: root
          commands:
            '01_append_fstab':
              command: /tmp/mount-efs.sh
            '02_create_drupal_dir':
              command: mkdir -p /var/www
              test: test ! -e /var/www
            '03_mount_efs':
              command: mount -a

        enable_php_repo:
          commands:
            '01_update_mysql_repo_gpg_key':
              command: rpm --import https://repo.mysql.com/RPM-GPG-KEY-mysql-2022
            '02_update server':
              command: yum update -y
            '03_enable_php_repo':
              command: !Join
                - ''
                - - 'amazon-linux-extras enable '
                  - !Ref 'PhpVersion'
            '04_clean_yum':
              command: yum clean metadata
        createdb:
          packages:
            rpm:
              mysql: "https://dev.mysql.com/get/mysql57-community-release-el7-11.noarch.rpm"
            yum:
              mysql-community-client: []
          files:
            /tmp/setup_drupaldb.sql:
              content: !Join
                - ''
                - - 'CREATE DATABASE IF NOT EXISTS '
                  - !Ref 'DrupalDbName'
                  - " CHARACTER SET UTF8 COLLATE utf8_general_ci;\n"
                  - 'GRANT ALL ON '
                  - !Ref 'DrupalDbName'
                  - .* TO '
                  - !Ref 'DrupalDbUsername'
                  - '''@''%'' IDENTIFIED BY '''
                  - !Ref 'DrupalDbPassword'
                  - "';\n"
              mode: '000400'
              owner: root
              group: root
          commands:
            '01_runQuery':
              command: !Join
                - ''
                - - 'mysql -u '
                  - !Ref 'DBMainUsername'
                  - ' --password='''
                  - !Ref 'DBMainUserPassword'
                  - ''''
                  - ' -h '
                  - !Ref 'DBEndpointAddress'
                  - " < /tmp/setup_drupaldb.sql || error_exit 'Failed to create database\
                    \ user'\n"
            '02_cleanup':
              command: sudo rm -f /tmp/setup_drupaldb.sql
        install-packageSet:
          packages:
            yum:
              git: []
              httpd: []
              php: []
              php-cli: []
              php-common: []
              php-pdo: []
              php-mysqlnd: []
              php-xml: []
              php-gd: []
              php-mbstring: []
              php-fpm: []
              php-opcache: []
              php-pecl-memcached: []
              php-pecl-apcu: []
        drupal-install-7:
          files:
            /etc/httpd/conf.d/drupal.conf:
              content: !Join
                - ''
                - - "<VirtualHost *:80>\n"
                  - '    ServerAdmin '
                  - !Ref 'DrupalSiteAdminEmail'
                  - "\n"
                  - '    ServerName  '
                  - !Ref 'DrupalSiteDomain'
                  - "\n"
                  - '    ServerAlias '
                  - !Join
                    - ''
                    - - www.
                      - !Ref 'DrupalSiteDomain'
                  - "\n"
                  - "    DocumentRoot /var/www/drupal\n"
                  - "    <Directory /var/www/drupal>\n"
                  - "        Options -Indexes -MultiViews +FollowSymLinks\n"
                  - "        AllowOverride All\n"
                  - "        Order allow,deny\n"
                  - "        allow from all\n"
                  - "    </Directory>\n"
                  - !If
                    - UseSSL
                    - !Join
                      - ''
                      - - "    RewriteEngine On\n"
                        - "    RewriteCond %{HTTP:X-Forwarded-Proto} =http\n"
                        - "    RewriteRule .* https://%{HTTP:Host}%{REQUEST_URI} [L,R=permanent]\n"
                    - ''
                  - "    LogLevel warn\n"
                  - "    ErrorLog /var/log/httpd/drupal-error.log\n"
                  - "    CustomLog /var/log/httpd/drupal-access.log combined\n"
                  - "</VirtualHost>\n"
                  - "ServerSignature Off\n"
                  - "ServerTokens Prod\n"
              mode: '000644'
              owner: root
              group: root
          commands:
            '01_install_composer':
              command: curl -sS https://getcomposer.org/installer | php
              cwd: /root
              env:
                HOME: /root
            '02_install_drush':
              command: /root/composer.phar global require drush/drush:8.*
              test: test -e /root/composer.phar
              env:
                HOME: /root
            '03_clean_httpd_confd_dir':
              command: rm -f autoindex.conf notrace.conf userdir.conf welcome.conf
              cwd: /etc/httpd/conf.d/
            '04_00_download_drupal':
              command: !Join
                - ''
                - - /root/.config/composer/vendor/bin/drush dl -y drupal-
                  - !Ref 'DrupalVersion'
                  - ' --drupal-project-rename drupal'
              cwd: /root
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '04_01_move_drupal':
              cwd: /root
              command: mv /root/drupal /var/www/drupal
            '05_disable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php.ini
              test: test -e /etc/php.ini
            '06_disable_expose_php':
              command: sed -i 's/expose_php = On/expose_php = Off/g' /etc/php.ini
              test: test -e /etc/php.ini
            '07_install_drupal':
              command: !Join
                - ''
                - - /root/.config/composer/vendor/bin/drush site-install standard --yes
                  - ' --site-name='''
                  - !Ref 'DrupalSiteName'
                  - ''' --site-mail='
                  - !Ref 'DrupalSiteAdminEmail'
                  - ' --account-name='
                  - !Ref 'DrupalSiteAdminUsername'
                  - ' --account-pass='
                  - !Ref 'DrupalSiteAdminPassword'
                  - ' --db-url=mysql://'
                  - !Ref 'DrupalDbUsername'
                  - ':'
                  - !Ref 'DrupalDbPassword'
                  - '@'
                  - !Ref 'DBEndpointAddress'
                  - /
                  - !Ref 'DrupalDbName'
                  - " --db-prefix=drupal_\n"
              cwd: /var/www/drupal
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '08_configure_drupal_https':
              cwd: /var/www/drupal/sites/default
              command: !If
                - UseSSL
                - echo "\$_SERVER['HTTPS'] = 'On';" >> settings.php
                - ''
            '09_set_drupal_folder_owner':
              command: chown -R ec2-user:apache /var/www/drupal
            '10_set_drupal_folder_permissions':
              command: chmod -R 750 /var/www/drupal
            '11_set_drupal_files_folder_permissions':
              command: chmod -R 770 /var/www/drupal/sites/default/files
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/httpd/conf.d/drupal.conf
                  - /etc/php.ini
                  - /var/www/drupal/sites/default/settings.php
        drupal-install-8:
          files:
            /etc/httpd/conf.d/drupal.conf:
              content: !Join
                - ''
                - - "<VirtualHost *:80>\n"
                  - '    ServerAdmin '
                  - !Ref 'DrupalSiteAdminEmail'
                  - "\n"
                  - '    ServerName  '
                  - !Ref 'DrupalSiteDomain'
                  - "\n"
                  - '    ServerAlias '
                  - !Join
                    - ''
                    - - www.
                      - !Ref 'DrupalSiteDomain'
                  - "\n"
                  - "    DocumentRoot /var/www/drupal/web\n"
                  - "    <Directory /var/www/drupal/web>\n"
                  - "        Options -Indexes -MultiViews +FollowSymLinks\n"
                  - "        AllowOverride All\n"
                  - "        Order allow,deny\n"
                  - "        allow from all\n"
                  - "    </Directory>\n"
                  - !If
                    - UseSSL
                    - !Join
                      - ''
                      - - "    RewriteEngine On\n"
                        - "    RewriteCond %{HTTP:X-Forwarded-Proto} =http\n"
                        - "    RewriteRule .* https://%{HTTP:Host}%{REQUEST_URI} [L,R=permanent]\n"
                    - ''
                  - "    LogLevel warn\n"
                  - "    ErrorLog /var/log/httpd/drupal-error.log\n"
                  - "    CustomLog /var/log/httpd/drupal-access.log combined\n"
                  - "</VirtualHost>\n"
                  - "ServerSignature Off\n"
                  - "ServerTokens Prod\n"
              mode: '000644'
              owner: root
              group: root
          commands:
            '01_install_composer':
              command: curl -sS https://getcomposer.org/installer | php
              cwd: /root
              env:
                HOME: /root
            '02_install_drush':
              command: /root/composer.phar global require drush/drush:9.*
              test: test -e /root/composer.phar
              env:
                HOME: /root
            '03_clean_httpd_confd_dir':
              command: rm -f autoindex.conf notrace.conf userdir.conf welcome.conf
              cwd: /etc/httpd/conf.d/
            '04_00_download_drupal':
              command: /root/composer.phar create-project drupal/recommended-project:8.* drupal
              cwd: /root
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '04_01_move_drupal':
              cwd: /root
              command: mv /root/drupal /var/www/drupal
            '05_disable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php.ini
              test: test -e /etc/php.ini
            '06_disable_expose_php':
              command: sed -i 's/expose_php = On/expose_php = Off/g' /etc/php.ini
              test: test -e /etc/php.ini
            '07_install_drupal':
              command: !Join
                - ''
                - - /root/.config/composer/vendor/bin/drush site-install standard --yes
                  - ' --site-name='''
                  - !Ref 'DrupalSiteName'
                  - ''' --site-mail='
                  - !Ref 'DrupalSiteAdminEmail'
                  - ' --account-name='
                  - !Ref 'DrupalSiteAdminUsername'
                  - ' --account-pass='
                  - !Ref 'DrupalSiteAdminPassword'
                  - ' --db-url=mysql://'
                  - !Ref 'DrupalDbUsername'
                  - ':'
                  - !Ref 'DrupalDbPassword'
                  - '@'
                  - !Ref 'DBEndpointAddress'
                  - /
                  - !Ref 'DrupalDbName'
                  - " --db-prefix=drupal_\n"
              cwd: /var/www/drupal
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '08_configure_drupal_https':
              cwd: /var/www/drupal/web/sites/default
              command: !If
                - UseSSL
                - echo "\$_SERVER['HTTPS'] = 'On';" >> settings.php
                - ''
            '09_set_drupal_folder_owner':
              command: chown -R ec2-user:apache /var/www/drupal
            '10_set_drupal_folder_permissions':
              command: chmod -R 750 /var/www/drupal
            '11_set_drupal_files_folder_permissions':
              command: chmod -R 770 /var/www/drupal/web/sites/default/files
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/httpd/conf.d/drupal.conf
                  - /etc/php.ini
                  - /var/www/drupal/web/sites/default/settings.php
        drupal-install-9:
          files:
            /etc/httpd/conf.d/drupal.conf:
              content: !Join
                - ''
                - - "<VirtualHost *:80>\n"
                  - '    ServerAdmin '
                  - !Ref 'DrupalSiteAdminEmail'
                  - "\n"
                  - '    ServerName  '
                  - !Ref 'DrupalSiteDomain'
                  - "\n"
                  - '    ServerAlias '
                  - !Join
                    - ''
                    - - www.
                      - !Ref 'DrupalSiteDomain'
                  - "\n"
                  - "    DocumentRoot /var/www/drupal/web\n"
                  - "    <Directory /var/www/drupal/web>\n"
                  - "        Options -Indexes -MultiViews +FollowSymLinks\n"
                  - "        AllowOverride All\n"
                  - "        Order allow,deny\n"
                  - "        allow from all\n"
                  - "    </Directory>\n"
                  - !If
                    - UseSSL
                    - !Join
                      - ''
                      - - "    RewriteEngine On\n"
                        - "    RewriteCond %{HTTP:X-Forwarded-Proto} =http\n"
                        - "    RewriteRule .* https://%{HTTP:Host}%{REQUEST_URI} [L,R=permanent]\n"
                    - ''
                  - "    LogLevel warn\n"
                  - "    ErrorLog /var/log/httpd/drupal-error.log\n"
                  - "    CustomLog /var/log/httpd/drupal-access.log combined\n"
                  - "</VirtualHost>\n"
                  - "ServerSignature Off\n"
                  - "ServerTokens Prod\n"
              mode: '000644'
              owner: root
              group: root
          commands:
            '01_install_composer':
              command: curl -sS https://getcomposer.org/installer | php
              cwd: /root
              env:
                HOME: /root
            '02_install_drush':
              command: /root/composer.phar global require drush/drush:10.*
              test: test -e /root/composer.phar
              env:
                HOME: /root
            '03_clean_httpd_confd_dir':
              command: rm -f autoindex.conf notrace.conf userdir.conf welcome.conf
              cwd: /etc/httpd/conf.d/
            '04_download_drupal':
              command: /root/composer.phar create-project drupal/recommended-project:9.* drupal
              cwd: /root
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '05_unlimit_php_memory':
              command: sed -i 's/memory_limit = 128M/memory_limit = -1/g' /etc/php.ini
            '06_install_local_drush':
              cwd: /root/drupal
              command: /root/composer.phar require drush/drush:^10
              env:
                HOME: /root              
            '07_disable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php.ini
              test: test -e /etc/php.ini
            '08_disable_expose_php':
              command: sed -i 's/expose_php = On/expose_php = Off/g' /etc/php.ini
              test: test -e /etc/php.ini 
            '09_move_drupal':
              cwd: /root
              command: mv /root/drupal /var/www/drupal
            '10_install_drupal':
              command: !Join
                - ''
                - - /root/.config/composer/vendor/bin/drush site-install standard --yes
                  - ' --site-name='''
                  - !Ref 'DrupalSiteName'
                  - ''' --site-mail='
                  - !Ref 'DrupalSiteAdminEmail'
                  - ' --account-name='
                  - !Ref 'DrupalSiteAdminUsername'
                  - ' --account-pass='
                  - !Ref 'DrupalSiteAdminPassword'
                  - ' --db-url=mysql://'
                  - !Ref 'DrupalDbUsername'
                  - ':'
                  - !Ref 'DrupalDbPassword'
                  - '@'
                  - !Ref 'DBEndpointAddress'
                  - /
                  - !Ref 'DrupalDbName'
                  - " --db-prefix=drupal_\n"
              cwd: /var/www/drupal
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '11_configure_drupal_https':
              cwd: /var/www/drupal/web/sites/default
              command: !If
                - UseSSL
                - echo "\$_SERVER['HTTPS'] = 'On';" >> settings.php
                - ''
            '12_set_drupal_folder_owner':
              command: chown -R ec2-user:apache /var/www/drupal
            '13_set_drupal_folder_permissions':
              command: chmod -R 750 /var/www/drupal
            '14_set_drupal_files_folder_permissions':
              command: chmod -R 770 /var/www/drupal/web/sites/default/files            
          services:
            sysvinit:
              httpd:
                enabled: 'true'
                ensureRunning: 'true'
                files:
                  - /etc/httpd/conf.d/drupal.conf
                  - /etc/php.ini
                  - /var/www/drupal/web/sites/default/settings.php
        memcached-drupal-7:
          files:
            /tmp/drupalCacheConfig.sh:
              content: !Join
                - ''
                - - "#!/bin/bash\n"
                  - "printf \"\n"
                  - "/**\n"
                  - "* Memcache Configuration\n"
                  - "*/\n"
                  - "\\$conf['cache_backends'][] = 'sites/all/modules/memcache/memcache.inc';\n"
                  - "\\$conf['cache_default_class'] = 'MemCacheDrupal';\n"
                  - "\\$conf['cache_class_cache_form'] = 'DrupalDatabaseCache';\n"
                  - "\\$conf['memcache_key_prefix'] = 'mc1';\n"
                  - "\\$conf['page_cache_without_database'] = TRUE;\n"
                  - "\\$conf['page_cache_invoke_hooks'] = FALSE;\n"
                  - "\\$conf['memcache_servers'] = array(\\n\"\n"
                  - "for node in \\\n"
                  - "`aws elasticache describe-cache-clusters --show-cache-node-info\
                    \ \\\n"
                  - '--cache-cluster-id '
                  - !Ref 'ElastiCacheClusterId'
                  - " \\\n"
                  - "--query 'CacheClusters[0].CacheNodes[*].Endpoint.[Address, Port]'\
                    \ \\\n"
                  - --output=text --region='
                  - !Ref 'AWS::Region'
                  - "'\\\n"
                  - "| sed -E -e 's/[[:space:]]+/:/g'`\n"
                  - "do\n"
                  - "printf \"    '\"$node\"' => 'default',\\n\"\n"
                  - "done\n"
                  - "printf \");\n"
                  - "\\$conf['memcache_bins'] = array(\n"
                  - "    'cache' => 'default',\n"
                  - );"
              mode: '000500'
              owner: root
              group: root
          commands:
            '01_download_memcahe_module':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush dl memcache
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '02_append_memcache_settings':
              cwd: /var/www/drupal/sites/default/
              command: /tmp/drupalCacheConfig.sh >> settings.php
            '03_enable_memcache_modules':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush en -y memcache memcache_admin
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '04_clear_cache':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush cc drush
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
        memcached-drupal-8:
          files:
            /tmp/drupalCacheConfig.sh:
              content: !Join
                - ''
                - - "#!/bin/bash\n"
                  - "printf \"\n"
                  - "// Memcache Configuration\n"
                  - "\\$settings['cache']['default'] = 'cache.backend.memcache';\n"
                  - "\\$settings['memcache']['key_prefix'] = 'dr8';\n"
                  - "\\$settings['memcache']['bins'] = [\n"
                  - "    'cache' => 'default',\n"
                  - "];\n"
                  - "\\$settings['memcache']['servers'] =  [\\n\"\
                    \n"
                  - "for node in \\\n"
                  - "`aws elasticache describe-cache-clusters --show-cache-node-info\
                    \ \\\n"
                  - '--cache-cluster-id '
                  - !Ref 'ElastiCacheClusterId'
                  - " \\\n"
                  - "--query 'CacheClusters[0].CacheNodes[*].Endpoint.[Address, Port]'\
                    \ \\\n"
                  - --output=text --region='
                  - !Ref 'AWS::Region'
                  - "'\\\n"
                  - "| sed -E -e 's/[[:space:]]+/:/g'`\n"
                  - "do\n"
                  - "printf \"    '\"$node\"' => 'default',\\n\"\n"
                  - "done\n"
                  - "printf \"];\"\n"
              mode: '000500'
              owner: root
              group: root
          commands:
            '01_enable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = Off/allow_url_fopen = On/g' /etc/php.ini
              test: test -e /etc/php.ini
            '02_add_memcache_module_to_required':
              cwd: /var/www/drupal
              command: /root/composer.phar require drupal/memcache drupal/memcache_admin
              env:
                HOME: /root
            '03_disable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php.ini
              test: test -e /etc/php.ini
            '04_enable_memcahe':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush en -y memcache memcache_admin
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '05_append_memcache_settings':
              cwd: /var/www/drupal/web/sites/default/
              command: /tmp/drupalCacheConfig.sh >> settings.php
        memcached-drupal-9:
          files:
            /tmp/drupalCacheConfig.sh:
              content: !Join
                - ''
                - - "#!/bin/bash\n"
                  - "printf \"\n"
                  - "// Memcache Configuration\n"
                  - "\\$settings['cache']['default'] = 'cache.backend.memcache';\n"
                  - "\\$settings['memcache']['key_prefix'] = 'dr9';\n"
                  - "\\$settings['memcache']['bins'] = [\n"
                  - "    'cache' => 'default',\n"
                  - "];\n"
                  - "\\$settings['memcache']['servers'] =  [\\n\"\
                    \n"
                  - "for node in \\\n"
                  - "`aws elasticache describe-cache-clusters --show-cache-node-info\
                    \ \\\n"
                  - '--cache-cluster-id '
                  - !Ref 'ElastiCacheClusterId'
                  - " \\\n"
                  - "--query 'CacheClusters[0].CacheNodes[*].Endpoint.[Address, Port]'\
                    \ \\\n"
                  - --output=text --region='
                  - !Ref 'AWS::Region'
                  - "'\\\n"
                  - "| sed -E -e 's/[[:space:]]+/:/g'`\n"
                  - "do\n"
                  - "printf \"    '\"$node\"' => 'default',\\n\"\n"
                  - "done\n"
                  - "printf \"];\"\n"
              mode: '000500'
              owner: root
              group: root
          commands:
            '01_enable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = Off/allow_url_fopen = On/g' /etc/php.ini
              test: test -e /etc/php.ini
            '02_add_memcache_module_to_required':
              cwd: /var/www/drupal
              command: /root/composer.phar require drupal/memcache drupal/memcache_admin
              env:
                HOME: /root
            '03_disable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php.ini
              test: test -e /etc/php.ini
            '04_enable_memcahe':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush en -y memcache memcache_admin
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '05_append_memcache_settings':
              cwd: /var/www/drupal/web/sites/default/
              command: /tmp/drupalCacheConfig.sh >> settings.php
        install-cdn-module-7:
          commands:
            '00_download_cdn_module':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush dl cdn
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '01_enable_cdn_module':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush en -y cdn
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
            '02_configure_cdn_module':
              cwd: /var/www/drupal
              command: !If
                - DrupalCdnModuleCondition
                - !Join
                  - ''
                  - - /root/.config/composer/vendor/bin/drush vset preprocess_js TRUE
                    - ' && '
                    - /root/.config/composer/vendor/bin/drush vset preprocess_css TRUE
                    - ' && '
                    - /root/.config/composer/vendor/bin/drush vset cdn_status '2'
                    - ' && '
                    - /root/.config/composer/vendor/bin/drush vset cdn_basic_mapping "http://
                    - !If
                      - CloudFrontAliasRoute53Condition
                      - !Ref 'CloudFrontAlias'
                      - !GetAtt 'CloudFrontStack.Outputs.CdnUrl'
                    - '"'
                    - !If
                      - UseSSL
                      - !Join
                        - ''
                        - - ' && '
                          - /root/.config/composer/vendor/bin/drush vset cdn_https_support
                            TRUE
                      - ''
                - ''
        install-cdn-module-8:
          commands:
            '01_enable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = Off/allow_url_fopen = On/g' /etc/php.ini
              test: test -e /etc/php.ini
            '02_add_cdn_module_to_required':
              cwd: /var/www/drupal
              command: /root/composer.phar require drupal/cdn drupal/cdn_ui
              env:
                HOME: /root
            '03_disable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php.ini
              test: test -e /etc/php.ini  
            '04_edit_cdn_settings_file':
              cwd: /var/www/drupal/web/modules/contrib/cdn/config/install
              command: !If
                - DrupalCdnModuleCondition
                - !Join
                  - ''
                  - - mv cdn.settings.yml cdn.settings.yml.org
                    - ' && '
                    - "printf \"langcode: en\nstatus: true\nmapping:\n  type: simple\n\
                      \  domain: "
                    - !If
                      - CloudFrontAliasRoute53Condition
                      - !Ref 'CloudFrontAlias'
                      - !GetAtt 'CloudFrontStack.Outputs.CdnUrl'
                    - "\n  conditions: []\nscheme: https://\nfarfuture:\n  status: true\nstream_wrappers:\n  - public\n\" > cdn.settings.yml"
                - ''
            '05_enable_cdn_module':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush en -y cdn cdn_ui
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
        install-cdn-module-9:
          commands:
            '01_enable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = Off/allow_url_fopen = On/g' /etc/php.ini
              test: test -e /etc/php.ini
            '02_add_cdn_module_to_required':
              cwd: /var/www/drupal
              command: /root/composer.phar require drupal/cdn drupal/cdn_ui
              env:
                HOME: /root
            '03_disable_php_allow_url_fopen':
              command: sed -i 's/allow_url_fopen = On/allow_url_fopen = Off/g' /etc/php.ini
              test: test -e /etc/php.ini                
            '04_edit_cdn_settings_file':
              cwd: /var/www/drupal/web/modules/contrib/cdn/config/install
              command: !If
                - DrupalCdnModuleCondition
                - !Join
                  - ''
                  - - mv cdn.settings.yml cdn.settings.yml.org
                    - ' && '
                    - "printf \"langcode: en\nstatus: true\nmapping:\n  type: simple\n\
                      \  domain: "
                    - !If
                      - CloudFrontAliasRoute53Condition
                      - !Ref 'CloudFrontAlias'
                      - !GetAtt 'CloudFrontStack.Outputs.CdnUrl'
                    - "\n  conditions:\n    not:\n      extensions: [css, js]\nscheme: https://\nfarfuture:\n  status: true\nstream_wrappers:\n  - public\n\" > cdn.settings.yml"
                - ''
            '05_enable_cdn_module':
              cwd: /var/www/drupal
              command: /root/.config/composer/vendor/bin/drush en -y cdn cdn_ui
              env:
                HOME: /root
                DRUSH_PHP: /usr/bin/php
    Properties:
      ImageId: !Ref LatestAmiId

      InstanceType: !Ref 'WebServerInstanceType'
      SubnetId: !Select
        - '0'
        - !Ref 'WebServerSubnets'
      SecurityGroupIds:
        - !Ref 'WebServerSecurityGroup'
      KeyName: !Ref 'KeyPair'
      IamInstanceProfile: !Ref 'WebServerInstanceProfile'
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash\n"
            - "yum update -y aws-cfn-bootstrap\n"
            - yum update -y
            - "\n"
            - '/opt/aws/bin/cfn-init -v '
            - '--stack '
            - !Ref 'AWS::StackName'
            - ' '
            - '--resource DrupalAMIEC2Instance '
            - '--configsets install_drupal '
            - '--region '
            - !Ref 'AWS::Region'
            - "\n"
            - !If
              - DrupalCdnModuleCondition
              - !Join
                - ''
                - - '/opt/aws/bin/cfn-init -v '
                  - '--stack '
                  - !Ref 'AWS::StackName'
                  - ' '
                  - '--resource DrupalAMIEC2Instance '
                  - '--configsets drupal_cdn_module '
                  - '--region '
                  - !Ref 'AWS::Region'
                  - "\n"
              - ''
            - '/opt/aws/bin/cfn-signal -e $? --stack '
            - !Ref 'AWS::StackName'
            - ' --resource DrupalAMIEC2Instance --region '
            - !Ref 'AWS::Region'
            - "\n"
      Tags:
        - Key: Name
          Value: !Join
            - ''
            - - !Ref 'AWS::StackName'
              - -AMI Instance
    CreationPolicy:
      ResourceSignal:
        Count: '1'
        Timeout: PT25M
  CreateDrupalAMI:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL:
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/create-ami.template.yaml'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        EC2InstanceId: !Ref 'DrupalAMIEC2Instance'
        AMIBaseName: Drupal
        ARNPartition: !If
          - GovCloudCondition
          - aws-us-gov
          - aws
  WebServerAsg:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      LaunchConfigurationName: !Ref 'WebServerLC'
      MinSize: !Ref 'WebServerMinSize'
      MaxSize: !Ref 'WebServerMaxSize'
      DesiredCapacity: !Ref 'WebServerDesiredCapacity'
      TargetGroupARNs:
        - !Ref 'ALBTargetGroup'
      VPCZoneIdentifier: !Ref 'WebServerSubnets'
      NotificationConfigurations:
        - TopicARN: !Ref 'NotificationTopic'
          NotificationTypes:
            - autoscaling:EC2_INSTANCE_LAUNCH
            - autoscaling:EC2_INSTANCE_LAUNCH_ERROR
            - autoscaling:EC2_INSTANCE_TERMINATE
            - autoscaling:EC2_INSTANCE_TERMINATE_ERROR
      Tags:
        - Key: Name
          Value: !Join
            - '-'
            - - !Ref 'AWS::StackName'
              - Web Server
          PropagateAtLaunch: true
  WebServerLC:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      ImageId: !GetAtt 'CreateDrupalAMI.Outputs.AMIId'
      InstanceType: !Ref 'WebServerInstanceType'
      SecurityGroups:
        - !Ref 'WebServerSecurityGroup'
      KeyName: !Ref 'KeyPair'
  NotificationTopic:
    Type: AWS::SNS::Topic
    Properties:
      Subscription:
        - Endpoint: !Ref 'AutoScalingNotificationEmail'
          Protocol: email
      TopicName: !Join
        - ''
        - - !Ref 'AWS::StackName'
          - -DrupalSnsTopic
  WebServerTargetTrackingScalingPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AutoScalingGroupName: !Ref 'WebServerAsg'
      Cooldown: '60'
      PolicyType: TargetTrackingScaling
      TargetTrackingConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ASGAverageCPUUtilization
        TargetValue: 75.0
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Subnets:
        - !Ref 'PublicSubnet1ID'
        - !Ref 'PublicSubnet2ID'
      SecurityGroups:
        - !Ref 'WebELBSecurityGroup'
      Tags:
        - Key: Name
          Value: DrupalWebserverAlb
  ALBTargetGroup:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckIntervalSeconds: 30
      HealthCheckTimeoutSeconds: 5
      HealthyThresholdCount: 2
      HealthCheckPort: '80'
      HealthCheckProtocol: HTTP
      Port: 80
      Protocol: HTTP
      UnhealthyThresholdCount: 5
      VpcId: !Ref 'VPCID'
      TargetGroupAttributes:
        - Key: stickiness.enabled
          Value: 'true'
        - Key: stickiness.type
          Value: lb_cookie
        - Key: stickiness.lb_cookie.duration_seconds
          Value: '30'
  ALBHTTPSListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Condition: UseSSL
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref 'ALBTargetGroup'
      LoadBalancerArn: !Ref 'ApplicationLoadBalancer'
      Port: 443
      Protocol: HTTPS
      Certificates:
        - !If
          - UseSSL
          - CertificateArn: !Ref 'SSLCertificateId'
          - !Ref 'AWS::NoValue'
  ALBHTTPListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - Type: forward
          TargetGroupArn: !Ref 'ALBTargetGroup'
      LoadBalancerArn: !Ref 'ApplicationLoadBalancer'
      Port: 80
      Protocol: HTTP
  DrupalSiteDomainRoute53Record:
    Type: AWS::Route53::RecordSet
    Condition: DrupalSiteDomainRoute53Condition
    Properties:
      Name: !Ref 'DrupalSiteDomain'
      Type: A
      HostedZoneId: !Ref 'Route53HostedZoneId'
      AliasTarget:
        DNSName: !GetAtt 'ApplicationLoadBalancer.DNSName'
        EvaluateTargetHealth: True
        HostedZoneId: !GetAtt 'ApplicationLoadBalancer.CanonicalHostedZoneID'
  CloudFrontStack:
    Type: AWS::CloudFormation::Stack
    Condition: DrupalCdnModuleCondition
    Properties:
      TemplateURL:
        !Sub
          - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}templates/cloudfront.template.yaml'
          - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
            S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        OriginDnsName: !If
          - DrupalSiteDomainRoute53Condition
          - !Ref 'DrupalSiteDomain'
          - !GetAtt 'ApplicationLoadBalancer.DNSName'
        OriginAccessProtocol: !If
          - UseSSL
          - https-only
          - http-only
        CloudFrontAlias: !Join
          - ','
          - - !Ref 'CloudFrontAlias'
        CustomSSLCertificateId: !If
          - CFUseSSL
          - !Ref 'CFSSLCertificateId'
          - ''
        CloudFrontPriceClass: !Ref 'CloudFrontPriceClass'
  CloudFrontAliasRoute53Record:
    Type: AWS::Route53::RecordSet
    Condition: CloudFrontAliasRoute53Condition
    Properties:
      Name: !Ref 'CloudFrontAlias'
      Type: A
      HostedZoneId: !Ref 'Route53HostedZoneId'
      AliasTarget:
        DNSName: !GetAtt 'CloudFrontStack.Outputs.CdnUrl'
        HostedZoneId: Z2FDTNDATAQYW2
Outputs:
  ELBURL:
    Description: The URL of the ELB that you should use to create a CNAME/ALIAS DNS
      record to point to your Domain e.g. mysite.com
    Value: !Join
      - ''
      - - !If
          - UseSSL
          - https://
          - http://
        - !GetAtt 'ApplicationLoadBalancer.DNSName'
